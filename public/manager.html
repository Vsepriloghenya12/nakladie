<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <title>Менеджер — Накладные</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        body { font-family: Arial; padding: 20px; max-width: 800px; margin:auto; }
        input, select { width: 100%; padding: 10px; margin: 6px 0; }
        button { padding: 12px 20px; cursor: pointer; }
        .invoice, .history-card {
            border: 1px solid #ccc; border-radius: 8px;
            padding: 12px; margin-top: 12px; background: #fff;
        }
        h2 { margin-top: 40px; }
        a.logout { display:block; margin-bottom:15px; }

        @media(max-width:600px) { button{ width:100%; } }
    </style>
</head>
<body>

<script>
if (localStorage.getItem("role") !== "manager")
    location.href = "/login.html";
</script>

<h1>Менеджер — накладные</h1>
<a href="/login.html" class="logout" onclick="localStorage.removeItem('role')">← выйти</a>

<!-- Форма -->
<div>

    <label>Поставщик</label>
    <select id="supplierSelect" onchange="onSupplierSelect()"></select>
    <button onclick="showNewSupplierInput()" id="newSupplierBtn" style="margin-bottom:10px;">
        + Новый поставщик
    </button>
    <input type="text" id="supplierInput" placeholder="Введите поставщика" style="display:none;">

    <label>Сумма</label>
    <input id="amount" type="number" step="0.01">

    <label>Тип организации</label>
    <select id="orgType">
        <option value="ООО">ООО</option>
        <option value="ИП">ИП</option>
    </select>

    <label>Дата прихода</label>
    <input id="arrivalDate" type="date">

    <label>
        <input type="checkbox" id="needRequest"> Нужно сделать новую заявку
    </label>

    <button onclick="createInvoice()">Создать накладную</button>
</div>

<h2>Неоплаченные накладные</h2>
<div id="invoiceList"></div>

<h2>История оплат (10 дней)</h2>
<div id="historyList"></div>

<script>
// suppliers
function loadSuppliers() {
    let s = JSON.parse(localStorage.getItem("suppliers")||"[]");
    const select = document.getElementById("supplierSelect");
    select.innerHTML = "";
    if (s.length===0) s=["Поставщик 1"];
    s.forEach(x=>{
        const o=document.createElement("option");
        o.value=o.textContent=x;
        select.appendChild(o);
    });
    localStorage.setItem("suppliers",JSON.stringify(s));
}
function saveSupplier(n){
    let s=JSON.parse(localStorage.getItem("suppliers")||"[]");
    if(!s.includes(n)){ s.push(n); s.sort(); localStorage.setItem("suppliers",JSON.stringify(s)); }
}
function showNewSupplierInput(){
    supplierSelect.style.display="none";
    newSupplierBtn.style.display="none";
    supplierInput.style.display="block";
    supplierInput.value="";
    supplierInput.focus();
}
function onSupplierSelect(){
    supplierInput.style.display="none";
    supplierSelect.style.display="block";
    newSupplierBtn.style.display="inline-block";
}

// создание
async function createInvoice() {
    const amountValue = document.getElementById("amount").value.trim();
    const arrivalValue = document.getElementById("arrivalDate").value.trim();

    let supplier = "";

    // Новый поставщик
    if (supplierInput.style.display === "block") {
        supplier = supplierInput.value.trim();
        if (!supplier) {
            alert("Введите поставщика");
            return;
        }
        saveSupplier(supplier);
    } else {
        supplier = supplierSelect.value.trim();
        if (!supplier) {
            alert("Выберите поставщика");
            return;
        }
    }

    if (!amountValue) {
        alert("Введите сумму");
        return;
    }

    await fetch("/api/invoice/create", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            supplier,
            amount: amountValue,
            organization_type: document.getElementById("orgType").value,
            arrival_date: arrivalValue,
            need_new_request: document.getElementById("needRequest").checked
        })
    });

    // очистка
    document.getElementById("amount").value = "";
    document.getElementById("needRequest").checked = false;
    supplierInput.style.display = "none";
    supplierSelect.style.display = "block";
    newSupplierBtn.style.display = "inline-block";

    loadInvoices();
}

// галочка
async function toggleNeed(id, state){
    await fetch(`/api/invoice/update/${id}`,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({need_new_request:state})
    });
}

// неоплаченные
async function loadInvoices(){
    const r=await fetch("/api/invoice/list");
    const d=await r.json();

    let html="";
    d.forEach(inv=>{
        html+=`
        <div class="invoice">
            <b>${inv.supplier}</b><br>
            Сумма: ${inv.amount} ₽<br>
            Тип: ${inv.organization_type}<br>
            Приход: ${inv.arrival_date}<br>
            Создано: ${inv.created_at.slice(0,10)}<br>

            <label>
                <input type="checkbox"
                    ${inv.need_new_request?"checked":""}
                    onchange="toggleNeed(${inv.id},this.checked)">
                Нужно сделать новую заявку
            </label>
        </div>`;
    });

    invoiceList.innerHTML = html || "Нет неоплаченных накладных";
}

// история
async function loadHistory(){
    const r=await fetch("/api/invoice/history");
    const d=await r.json();
    let html="";

    if(d.length===0) html="Нет оплат за 10 дней";
    else d.forEach(inv=>{
        html+=`
        <div class="history-card">
            <b>${inv.supplier}</b><br>
            Сумма: ${inv.amount} ₽<br>
            Тип: ${inv.organization_type}<br>
            Приход: ${inv.arrival_date}<br>
            Оплачено: ${inv.paid_at.slice(0,10)}<br>
            ${
                inv.payment_file
                ? `<a href="${inv.payment_file}" download>Платёжка: скачать</a>`
                : "(файл отсутствует)"
            }
        </div>`;
    });

    historyList.innerHTML=html;
}

// загрузка
document.getElementById("arrivalDate").value = new Date().toISOString().slice(0,10);

loadSuppliers();
loadInvoices();
loadHistory();

</script>

</body>
</html>
