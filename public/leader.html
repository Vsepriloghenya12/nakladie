<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Руководитель — накладные</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        body { font-family:Arial; padding:20px; max-width:900px; margin:auto; }
        table { width:100%; border-collapse:collapse; margin-top:20px; }
        th,td{ border:1px solid #ccc; padding:10px; text-align:center; }
        button { padding:6px 12px; margin:3px 0; cursor:pointer; }
        a.logout{display:inline-block;margin-bottom:15px;}

        .p1{background:#fff;}
        .p2{background:#fff4d2;}
        .p3{background:#ffe1b3;}
        .p4{background:#ffc5b5;}
        .p5{background:#ff9999;}

        @media(max-width:600px){
            table,thead,tbody,tr,td{display:block;}
            thead{display:none;}
            tr{margin-bottom:12px;background:#fff;border-radius:8px;padding:10px;}
            td{display:flex;justify-content:space-between;border:none;border-bottom:1px solid #eee;}
            td:last-child{border-bottom:none;}
            td::before{content:attr(data-label);font-weight:bold;}
            button{width:100%;}
        }
    </style>
</head>
<body>

<script>
if(localStorage.getItem("role")!=="leader") location.href="/login.html";
</script>

<h1>Накладные — Руководитель</h1>
<a href="/login.html" class="logout" onclick="localStorage.removeItem('role')">← выйти</a>

<table>
<thead>
<tr>
    <th>Поставщик</th>
    <th>Сумма</th>
    <th>Тип</th>
    <th>Приход</th>
    <th>Дней прошло</th>
    <th>Просрочка</th>
    <th>Нужна новая?</th>
    <th>Приоритет</th>
    <th>Действия</th>
</tr>
</thead>
<tbody id="invoiceTable"></tbody>
</table>

<input type="file" id="fileInput" accept="application/pdf" style="display:none;">

<script>
let currentId=null;

async function loadInvoices(){
    const r=await fetch("/api/invoice/list");
    let d=await r.json();

    const now=new Date();

    d=d.map(i=>{
        const created=new Date(i.created_at);
        const days=Math.floor((now-created)/86400000);
        const overdue=Math.max(0,days-7);

        let p=1;
        if(overdue>=1&&overdue<=3)p=2;
        else if(overdue<=7)p=3;
        else if(overdue<=14)p=4;
        else p=5;

        if(i.need_new_request) p=Math.min(5,p+1);

        return {...i,days,overdue,priority:p};
    });

    d.sort((a,b)=>b.priority-a.priority);

    let html="";
    if(d.length===0){
        html=`<tr><td colspan="9">Нет неоплаченных накладных</td></tr>`;
    } else {
        d.forEach(inv=>{
            html+=`
            <tr class="p${inv.priority}">
                <td data-label="Поставщик">${inv.supplier}</td>
                <td data-label="Сумма">${inv.amount} ₽</td>
                <td data-label="Тип">${inv.organization_type}</td>
                <td data-label="Приход">${inv.arrival_date}</td>
                <td data-label="Дней">${inv.days}</td>
                <td data-label="Просрочка">${inv.overdue}</td>
                <td data-label="Нужна новая">${inv.need_new_request?"Да":"Нет"}</td>
                <td data-label="Приоритет">${inv.priority}</td>

                <td data-label="Действия">
                    <button onclick="markPaid(${inv.id})">Оплачено</button>
                    <button onclick="openUpload(${inv.id})">Загрузить платёжку</button>
                </td>
            </tr>`;
        });
    }

    invoiceTable.innerHTML=html;
}

async function markPaid(id){
    await fetch(`/api/invoice/mark-paid/${id}`,{method:"POST"});
    loadInvoices();
}

function openUpload(id){
    currentId=id;
    fileInput.click();
}

fileInput.addEventListener("change", async function(){
    if(!this.files.length)return;

    const fd = new FormData();
    fd.append("payment",this.files[0]);

    await fetch(`/api/invoice/upload-payment/${currentId}`,{
        method:"POST",
        body:fd
    });

    this.value="";
    loadInvoices();
});

loadInvoices();
</script>

</body>
</html>
